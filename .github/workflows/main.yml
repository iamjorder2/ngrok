name: Windows RDP Custom Login

on:
  workflow_dispatch:

jobs:
  run-rdp:
    runs-on: windows-latest

    steps:
      - name: Install ngrok via NPM
        shell: pwsh
        run: |
          npm install -g ngrok
          Write-Host "ngrok install complete."

      - name: Configure RDP and Custom User
        shell: pwsh
        run: |
          # রিমোট ডেস্কটপ এনাবল করা
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          
          # আপনার দেওয়া ইউজারনেম এবং পাসওয়ার্ড সেট করা
          $Username = "iamjorder"
          $PlainPassword = "Mamunja@201"
          $Password = ConvertTo-SecureString $PlainPassword -AsPlainText -Force
          
          # নতুন ইউজার তৈরি এবং অ্যাডমিন গ্রুপে যোগ করা
          New-LocalUser -Name $Username -Password $Password -FullName "Custom Admin" -Description "RDP User"
          Add-LocalGroupMember -Group "Administrators" -Member $Username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username
          
          Write-Host "User $Username has been created and RDP is ready!"

      - name: Start ngrok Tunnel
        shell: pwsh
        run: |
          $token = "${{ secrets.NGROK_AUTH_TOKEN }}"
          # ngrok ব্যাকগ্রাউন্ডে চালু করা
          cmd /c "start /b ngrok tcp 3389 --authtoken $token"
          
          Write-Host "Waiting for ngrok URL..."
          Start-Sleep -Seconds 30
          
          try {
              $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
              $publicUrl = $response.tunnels[0].public_url
              echo "NGROK_URL=$publicUrl" >> $env:GITHUB_ENV
              Write-Host "Connection URL: $publicUrl"
          } catch {
              Write-Error "Failed to get ngrok URL. Check your Auth Token."
              exit 1
          }

      - name: Final Connection Details
        shell: pwsh
        run: |
          Write-Host "------------------------------------------"
          Write-Host "RDP Address : ${{ env.NGROK_URL }}"
          Write-Host "Username    : iamjorder"
          Write-Host "Password    : Mamunja@201"
          Write-Host "------------------------------------------"
          Write-Host "RDP is now active for 6 hours."
          Start-Sleep -Seconds 21600
